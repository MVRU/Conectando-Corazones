generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Archivo {
  id_archivo        Int       @id @default(autoincrement())
  nombre_original   String?
  url               String
  descripcion       String?
  tipo_mime         String?
  tamanio_bytes     Int?
  created_at        DateTime  @default(now())
  fecha_vencimiento DateTime?

  usuario_id   Int?
  evidencia_id Int?
  proyecto_id  Int?

  usuario   Usuario?   @relation(fields: [usuario_id], references: [id_usuario])
  evidencia Evidencia? @relation(fields: [evidencia_id], references: [id_evidencia])
  proyecto  Proyecto?  @relation(fields: [proyecto_id], references: [id_proyecto])

  @@map("archivos")
}

model Categoria {
  id_categoria Int    @id @default(autoincrement())
  descripcion  String

  proyecto_categorias   ProyectoCategoria[]
  categorias_preferidas CategoriasPreferidas[]

  @@map("categorias")
}

model CategoriasPreferidas {
  id_categoria_preferida Int @id @default(autoincrement())
  usuario_id             Int
  categoria_id           Int

  usuario   Usuario   @relation(fields: [usuario_id], references: [id_usuario])
  categoria Categoria @relation(fields: [categoria_id], references: [id_categoria])

  @@unique([usuario_id, categoria_id]) // Garantiza que la preferencia sea única por usuario
  @@map("categorias_preferidas")
}

model Colaboracion {
  id_colaboracion Int       @id @default(autoincrement())
  estado          String // pending, approved, refused, cancelled
  justificacion   String?
  created_at      DateTime? @default(now())
  mensaje         String?

  proyecto_id    Int?
  colaborador_id Int?

  proyecto    Proyecto? @relation(fields: [proyecto_id], references: [id_proyecto])
  colaborador Usuario?  @relation(fields: [colaborador_id], references: [id_usuario])

  colaboraciones_tipo_participacion ColaboracionTipoParticipacion[]
  @@unique([proyecto_id, colaborador_id]) // Un colaborador no puede enviar más de una solicitud de colaboración al mismo proyecto
  @@map("colaboraciones")
}

model ColaboracionTipoParticipacion {
  id_colaboracion_tipo_participacion Int  @id @default(autoincrement())
  colaboracion_id                    Int?
  participacion_permitida_id         Int?
  cantidad                           Int

  colaboracion            Colaboracion?           @relation(fields: [colaboracion_id], references: [id_colaboracion])
  participacion_permitida ParticipacionPermitida? @relation(fields: [participacion_permitida_id], references: [id_participacion_permitida], onDelete: Restrict)

  @@unique([colaboracion_id, participacion_permitida_id]) // Evita que una misma colaboración tenga dos filas distintas para el mismo tipo de participación permitida
  @@map("colaboraciones_tipo_participacion")
}

model Consentimiento {
  id_consentimiento Int       @id @default(autoincrement())
  tipo              String
  version           String
  created_at        DateTime? @default(now())
  usuario_id        Int?

  usuario Usuario? @relation(fields: [usuario_id], references: [id_usuario])

  @@map("consentimientos")
}

model Contacto {
  id_contacto   Int     @id @default(autoincrement())
  tipo_contacto String
  valor         String
  etiqueta      String?
  usuario_id    Int?

  usuario Usuario? @relation(fields: [usuario_id], references: [id_usuario])

  @@map("contactos")
}

model Estado {
  id_estado   Int    @id @default(autoincrement())
  descripcion String @unique

  proyectos Proyecto[]

  @@map("estados")
}

model Evaluacion {
  id_evaluacion  Int       @id @default(autoincrement())
  voto           String? // aprobado, rechazado
  created_at     DateTime? @default(now())
  justificacion  String?
  solicitud_id   Int?
  colaborador_id Int?

  solicitud   SolicitudFinalizacion? @relation(fields: [solicitud_id], references: [id_solicitud])
  colaborador Usuario?               @relation(fields: [colaborador_id], references: [id_usuario])

  @@unique([solicitud_id, colaborador_id]) // Evita fraude o duplicidad de votos en el proceso de cierre
  @@map("evaluaciones")
}

model Evidencia {
  id_evidencia               Int      @id @default(autoincrement())
  tipo_evidencia             String
  created_at                 DateTime @default(now())
  id_participacion_permitida Int

  participacion_permitida ParticipacionPermitida @relation(fields: [id_participacion_permitida], references: [id_participacion_permitida])

  archivos             Archivo[]
  solicitud_evidencias SolicitudFinalizacionEvidencia[]

  @@unique([id_participacion_permitida, tipo_evidencia]) // Garantiza una única carpeta/registro de evidencia por tipo para una participación
  @@map("evidencias")
}

model HistorialDeCambios {
  id_cambio         Int       @id @default(autoincrement())
  tipo_objeto       String
  id_objeto         Int
  accion            String
  atributo_afectado String
  valor_anterior    String
  valor_nuevo       String
  justificacion     String?
  created_at        DateTime? @default(now())
  usuario_id        Int? // nullable

  usuario Usuario? @relation(fields: [usuario_id], references: [id_usuario])

  @@map("historial_de_cambios")
}

model Localidad {
  id_localidad  Int    @id @default(autoincrement())
  codigo_postal String
  nombre        String
  id_provincia  Int?

  provincia   Provincia?  @relation(fields: [id_provincia], references: [id_provincia])
  ubicaciones Ubicacion[]
  usuarios    Usuario[]

  @@map("localidades")
}

model Parametro {
  id_parametro Int    @id @default(autoincrement())
  nombre       String
  valor        String
  tipo         String
  descripcion  String

  @@map("parametros")
}

model ParticipacionPermitida {
  id_participacion_permitida Int     @id @default(autoincrement())
  id_proyecto                Int?
  id_tipo_participacion      Int?
  objetivo                   Int
  // actual                     Int?    @default(0)
  unidad_medida              String?
  especie                    String?

  proyecto           Proyecto?          @relation(fields: [id_proyecto], references: [id_proyecto])
  tipo_participacion TipoParticipacion? @relation(fields: [id_tipo_participacion], references: [id_tipo_participacion])

  colaboraciones_tipo_participacion ColaboracionTipoParticipacion[]
  evidencias                        Evidencia[]


  @@map("participaciones_permitidas")
}

model Provincia {
  id_provincia Int     @id @default(autoincrement())
  nombre       String
  nombre_corto String?
  codigo_iso   String?

  localidades Localidad[]

  @@map("provincias")
}

model Proyecto {
  id_proyecto                Int       @id @default(autoincrement())
  titulo                     String
  descripcion                String
  resumen                    String?
  aprendizajes               String?
  url_portada                String?
  created_at                 DateTime  @default(now())
  updated_at                 DateTime? @updatedAt
  fecha_cierre_postulaciones DateTime?
  fecha_fin_tentativa        DateTime?
  beneficiarios              Int?
  id_chat_firebase           String?
  estado_id                  Int?
  institucion_id             Int

  estado      Estado? @relation(fields: [estado_id], references: [id_estado])
  institucion Usuario @relation(fields: [institucion_id], references: [id_usuario])

  archivos                 Archivo[]
  colaboraciones           Colaboracion[]
  participacion_permitida  ParticipacionPermitida[]
  proyecto_categorias      ProyectoCategoria[]
  proyecto_ubicaciones     ProyectoUbicacion[]
  solicitudes_finalizacion SolicitudFinalizacion[]

  @@map("proyectos")
}

model ProyectoCategoria {
  id_proyecto_categoria Int @id @default(autoincrement())
  categoria_id          Int
  proyecto_id           Int

  categoria Categoria @relation(fields: [categoria_id], references: [id_categoria])
  proyecto  Proyecto  @relation(fields: [proyecto_id], references: [id_proyecto])

  @@unique([proyecto_id, categoria_id]) // Evita duplicidad en la categorización del proyecto
  @@map("proyecto_categorias")
}

model ProyectoUbicacion {
  id_proyecto_ubicacion Int @id @default(autoincrement())
  proyecto_id           Int
  ubicacion_id          Int

  proyecto  Proyecto  @relation(fields: [proyecto_id], references: [id_proyecto])
  ubicacion Ubicacion @relation(fields: [ubicacion_id], references: [id_ubicacion])

  @@unique([proyecto_id, ubicacion_id]) // Evita duplicidad en la ubicación del proyecto
  @@map("proyecto_ubicaciones")
}

model Reporte {
  id_reporte            Int       @id @default(autoincrement())
  tipo_objeto           String
  id_objeto             Int
  motivo                String
  descripcion           String
  created_at            DateTime? @default(now())
  estado                String? // pendiente, resuelto, rechazado
  fecha_resolucion      DateTime?
  comentario_resolucion String?

  reportante_id Int
  admin_id      Int?

  reportante Usuario  @relation("Reportante", fields: [reportante_id], references: [id_usuario])
  admin      Usuario? @relation("AdminResolutor", fields: [admin_id], references: [id_usuario])

  @@unique([reportante_id, tipo_objeto, id_objeto]) // Un usuario solo debería reportar una vez por entidad
  @@map("reportes")
}

model Resena {
  id_resena   Int      @id @default(autoincrement())
  tipo_objeto String?
  id_objeto   Int?
  contenido   String
  puntaje     Int
  aprobado    Boolean?
  rol         String?
  username    String?

  @@unique([username, tipo_objeto, id_objeto]) // Un usuario solo debería opinar una vez por entidad
  @@map("resenas")
}

model SolicitudFinalizacion {
  id_solicitud Int       @id @default(autoincrement())
  estado       String?
  created_at   DateTime? @default(now())
  proyecto_id  Int

  proyecto Proyecto @relation(fields: [proyecto_id], references: [id_proyecto])

  evaluaciones         Evaluacion[]
  solicitud_evidencias SolicitudFinalizacionEvidencia[]

  @@map("solicitudes_finalizacion")
}

model SolicitudFinalizacionEvidencia {
  id_solicitud_finalizacion_evidencia Int @id @default(autoincrement())
  evidencia_id                        Int
  solicitud_finalizacion_id           Int

  evidencia              Evidencia             @relation(fields: [evidencia_id], references: [id_evidencia])
  solicitud_finalizacion SolicitudFinalizacion @relation(fields: [solicitud_finalizacion_id], references: [id_solicitud])

  @@unique([evidencia_id, solicitud_finalizacion_id])
  @@map("solicitud_finalizacion_evidencias")
}

model TipoParticipacion {
  id_tipo_participacion Int    @id @default(autoincrement())
  descripcion           String

  participaciones                ParticipacionPermitida[]
  tipos_participacion_preferidos TiposParticipacionPreferidos[]

  @@map("tipos_participacion")
}

model TiposParticipacionPreferidos {
  id_tipos_participacion_preferidas Int @id @default(autoincrement())
  usuario_id                        Int
  tipo_participacion_id             Int

  usuario            Usuario           @relation(fields: [usuario_id], references: [id_usuario])
  tipo_participacion TipoParticipacion @relation(fields: [tipo_participacion_id], references: [id_tipo_participacion])

  @@unique([usuario_id, tipo_participacion_id]) // Garantiza que la preferencia sea única por usuario
  @@map("tipos_participacion_preferidos")
}

model Ubicacion {
  id_ubicacion    Int     @id @default(autoincrement())
  tipo_ubicacion  String
  modalidad       String
  calle           String?
  numero          String?
  piso            String?
  departamento    String?
  referencia      String?
  url_google_maps String?
  url_virtual     String?

  localidad_id Int?

  localidad            Localidad?          @relation(fields: [localidad_id], references: [id_localidad])
  proyecto_ubicaciones ProyectoUbicacion[]

  @@map("ubicaciones")
}

model Usuario {
  id_usuario          Int       @id @default(autoincrement())
  username            String    @unique
  auth_user_id        String?   @unique // Vinculación con Supabase Auth
  password            String?   // Opcional, ya que Supabase maneja la auth
  nombre              String
  apellido            String
  fecha_nacimiento    DateTime?
  estado              String
  created_at          DateTime? @default(now())
  rol                 String    @default("colaborador")
  url_foto            String
  estado_verificacion String?
  descripcion         String?
  nombre_legal        String? // Institucion
  tipo_institucion    String? // Institucion
  tipo_colaborador    String? // Colaborador
  razon_social        String? // Colaborador (Organización)
  con_fines_de_lucro  Boolean? // Colaborador (Organización)
  localidad_id        Int?

  localidad                      Localidad?                     @relation(fields: [localidad_id], references: [id_localidad])
  archivos                       Archivo[]
  categorias_preferidas          CategoriasPreferidas[]
  colaboraciones                 Colaboracion[]
  consentimientos                Consentimiento[]
  contactos                      Contacto[]
  evaluaciones                   Evaluacion[]
  historial_cambios              HistorialDeCambios[]
  proyectos_institucion          Proyecto[] // Relation to Proyecto.institucion_id
  reportes_creados               Reporte[]                      @relation("Reportante")
  reportes_resueltos             Reporte[]                      @relation("AdminResolutor")
  tipos_participacion_preferidos TiposParticipacionPreferidos[]
  verificaciones                 Verificacion[]

  @@map("usuarios")
}

model Verificacion {
  id_verificacion   Int       @id @default(autoincrement())
  tipo              String
  estado            String
  created_at        DateTime? @default(now())
  fecha_vencimiento DateTime?
  usuario_id        Int?

  usuario Usuario? @relation(fields: [usuario_id], references: [id_usuario])

  @@map("verificaciones")
}
