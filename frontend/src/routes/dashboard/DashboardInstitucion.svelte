<!--
* Componente: DashboardInstitucion
	-*- Descripción: Dashboard especializado para instituciones que gestionan proyectos
	-*- KPIs: gestión de proyectos, recaudación, colaboradores, análisis de rendimiento, alcance
-->

<script lang="ts">
	import { onMount } from 'svelte';
	import ProgressBar from '$lib/components/ui/elements/ProgressBar.svelte';
	import Badge from '$lib/components/ui/elements/Badge.svelte';
	
	// Datos para gestión institucional
	const institucionInfo = {
		nombre: "Cruz Roja Argentina",
		tipoOrganizacion: "ONG",
		tiempoPlataforma: "2 años",
		proyectosPublicados: 15,
		proyectosActivos: 6,
		totalRecaudado: 127500
	};

	const proyectosActivos = [
		{
			id: 1,
			titulo: "Botiquín para escuela rural",
			fechaCreacion: "2024-03-15",
			deadline: "2024-07-30",
			objetivo: 25000,
			recaudado: 18750,
			progreso: 75,
			colaboradores: 23,
			visualizaciones: 1200,
			estado: "en_progreso",
			urgencia: "media"
		},
		{
			id: 2,
			titulo: "Comedor comunitario Villa Esperanza",
			fechaCreacion: "2024-04-01",
			deadline: "2024-08-15",
			objetivo: 50000,
			recaudado: 32000,
			progreso: 64,
			colaboradores: 18,
			visualizaciones: 890,
			estado: "en_progreso",
			urgencia: "alta"
		},
		{
			id: 3,
			titulo: "Libros para biblioteca móvil",
			fechaCreacion: "2024-05-10",
			deadline: "2024-09-20",
			objetivo: 15000,
			recaudado: 12750,
			progreso: 85,
			colaboradores: 31,
			visualizaciones: 1450,
			estado: "proximo_cierre",
			urgencia: "baja"
		}
	];

	const colaboradoresAnalisis = [
		{
			categoria: "Donantes Recurrentes",
			cantidad: 45,
			porcentaje: 60,
			aporte: "Mayor contribución económica",
			tendencia: "creciente"
		},
		{
			categoria: "Voluntarios Activos",
			cantidad: 28,
			porcentaje: 75,
			aporte: "Tiempo y habilidades",
			tendencia: "estable"
		},
		{
			categoria: "Donantes Ocasionales",
			cantidad: 89,
			porcentaje: 30,
			aporte: "Donaciones puntuales",
			tendencia: "variable"
		},
		{
			categoria: "Organizaciones Aliadas",
			cantidad: 7,
			porcentaje: 85,
			aporte: "Recursos y redes",
			tendencia: "creciente"
		}
	];

	const metricsRendimiento = {
		promedioRecaudacion: 8500,
		tiempoPromedioCompletar: "4.2 meses",
		tasaExito: 87,
		proyectoMasExitoso: "Comedor Villa Norte",
		mejorMes: "Mayo 2024"
	};

	const proximasAcciones = [
		{
			tipo: "deadline",
			descripcion: "Revisión de progreso - Botiquín escuela",
			fecha: "En 3 días",
			urgencia: "alta"
		},
		{
			tipo: "comunicacion",
			descripcion: "Actualizar beneficiarios sobre comedor",
			fecha: "En 1 semana",
			urgencia: "media"
		},
		{
			tipo: "recaudacion",
			descripcion: "Campaña final biblioteca móvil",
			fecha: "En 2 semanas",
			urgencia: "alta"
		}
	];

	const estadisticasAlcance = {
		totalVisualizaciones: 5640,
		interaccionesUltimoMes: 234,
		compartidoEnRedes: 89,
		nuevosSeguidores: 45
	};

	const tendenciasMensuales = [
		{ mes: "Ene", recaudado: 8500, colaboradores: 12 },
		{ mes: "Feb", recaudado: 12300, colaboradores: 18 },
		{ mes: "Mar", recaudado: 15600, colaboradores: 25 },
		{ mes: "Abr", recaudado: 22100, colaboradores: 31 },
		{ mes: "May", recaudado: 34200, colaboradores: 42 },
		{ mes: "Jun", recaudado: 34650, colaboradores: 45 }
	];

	let animate = false;

	onMount(() => {
		setTimeout(() => animate = true, 100);
	});

	function getEstadoColor(estado: string) {
		switch (estado) {
			case 'en_progreso': return 'border-blue-200 bg-blue-50 text-blue-700';
			case 'proximo_cierre': return 'border-green-200 bg-green-50 text-green-700';
			case 'finalizado': return 'border-gray-200 bg-gray-50 text-gray-700';
			default: return 'border-gray-200 bg-gray-50 text-gray-700';
		}
	}

	function getUrgenciaIcon(urgencia: string) {
		switch (urgencia) {
			case 'alta': return '🔥';
			case 'media': return '⚡';
			case 'baja': return '💚';
			default: return '📋';
		}
	}

	function getTendenciaIcon(tendencia: string) {
		switch (tendencia) {
			case 'creciente': return '📈';
			case 'estable': return '➡️';
			case 'variable': return '📊';
			default: return '📋';
		}
	}
</script>

<div class="space-y-8">
	<!-- Header Institucional -->
	<div 
		class="rounded-2xl border border-purple-200 bg-gradient-to-r from-purple-500 via-purple-600 to-indigo-600 p-6 text-white shadow-lg"
		class:opacity-0={!animate}
		class:translate-y-4={!animate}
		style="transition-delay: 100ms"
	>
		<div class="flex items-center justify-between mb-4">
			<div class="flex items-center gap-4">
				<div class="h-16 w-16 rounded-full bg-white/20 flex items-center justify-center text-2xl">
					🏢
				</div>
				<div>
					<h1 class="text-2xl font-bold">{institucionInfo.nombre}</h1>
					<p class="text-purple-100">
						{institucionInfo.tipoOrganizacion} • En plataforma {institucionInfo.tiempoPlataforma}
					</p>
				</div>
			</div>
			<div class="text-right">
				<p class="text-3xl font-bold">${institucionInfo.totalRecaudado.toLocaleString()}</p>
				<p class="text-sm text-purple-100">Total Recaudado</p>
			</div>
		</div>
		
		<div class="grid gap-4 sm:grid-cols-3">
			<div class="bg-white/10 rounded-lg p-3 text-center">
				<p class="text-2xl font-bold">{institucionInfo.proyectosPublicados}</p>
				<p class="text-sm text-purple-100">Proyectos Publicados</p>
			</div>
			<div class="bg-white/10 rounded-lg p-3 text-center">
				<p class="text-2xl font-bold">{institucionInfo.proyectosActivos}</p>
				<p class="text-sm text-purple-100">Proyectos Activos</p>
			</div>
			<div class="bg-white/10 rounded-lg p-3 text-center">
				<p class="text-2xl font-bold">{metricsRendimiento.tasaExito}%</p>
				<p class="text-sm text-purple-100">Tasa de Éxito</p>
			</div>
		</div>
	</div>

	<!-- Gestión de Proyectos Activos -->
	<div 
		class="rounded-2xl border border-gray-200 bg-white p-6 shadow-lg"
		class:opacity-0={!animate}
		class:translate-y-4={!animate}
		style="transition-delay: 200ms"
	>
		<h2 class="mb-6 text-xl font-bold text-gray-900">🎯 Gestión de Proyectos Activos</h2>
		
		<div class="space-y-4">
			{#each proyectosActivos as proyecto, i}
				<div 
					class="rounded-xl border {getEstadoColor(proyecto.estado)} p-5 transition-all duration-300 hover:shadow-md"
					class:opacity-0={!animate}
					style="transition-delay: {300 + i * 100}ms"
				>
					<div class="flex justify-between items-start mb-3">
						<div class="flex-1">
							<div class="flex items-center gap-2 mb-1">
								<h3 class="font-semibold text-lg">{proyecto.titulo}</h3>
								<span class="text-lg">{getUrgenciaIcon(proyecto.urgencia)}</span>
							</div>
							<div class="flex gap-4 text-sm opacity-75 mb-2">
								<span>📅 Deadline: {new Date(proyecto.deadline).toLocaleDateString('es-AR')}</span>
								<span>👥 {proyecto.colaboradores} colaboradores</span>
								<span>👁️ {proyecto.visualizaciones} visualizaciones</span>
							</div>
						</div>
						<div class="text-right">
							<p class="text-2xl font-bold">{proyecto.progreso}%</p>
							<p class="text-sm opacity-75">Progreso</p>
						</div>
					</div>
					
					<div class="mb-3">
						<ProgressBar percent={proyecto.progreso} color={proyecto.progreso > 80 ? 'green' : proyecto.progreso > 50 ? 'blue' : 'purple'} />
						<div class="mt-2 flex justify-between text-sm">
							<span class="font-medium">${proyecto.recaudado.toLocaleString()} recaudado</span>
							<span>Meta: ${proyecto.objetivo.toLocaleString()}</span>
						</div>
					</div>

					<div class="flex gap-2">
						<button class="px-3 py-1 text-xs bg-white/60 rounded-full hover:bg-white/80 transition-colors">
							Ver detalles
						</button>
						<button class="px-3 py-1 text-xs bg-white/60 rounded-full hover:bg-white/80 transition-colors">
							Contactar colaboradores
						</button>
						<button class="px-3 py-1 text-xs bg-white/60 rounded-full hover:bg-white/80 transition-colors">
							Actualizar progreso
						</button>
					</div>
				</div>
			{/each}
		</div>
	</div>

	<!-- Fila de análisis: Colaboradores y Rendimiento -->
	<div class="grid gap-6 lg:grid-cols-2">
		<!-- Análisis de Colaboradores -->
		<div 
			class="rounded-2xl border border-gray-200 bg-white p-6 shadow-lg"
			class:opacity-0={!animate}
			class:translate-y-4={!animate}
			style="transition-delay: 400ms"
		>
			<h2 class="mb-6 text-lg font-bold text-gray-900">👥 Análisis de Colaboradores</h2>
			
			<div class="space-y-4">
				{#each colaboradoresAnalisis as categoria, i}
					<div 
						class="rounded-lg border border-gray-100 p-4 hover:bg-gray-50 transition-colors"
						class:opacity-0={!animate}
						style="transition-delay: {500 + i * 100}ms"
					>
						<div class="flex justify-between items-start mb-2">
							<div class="flex-1">
								<div class="flex items-center gap-2">
									<h4 class="font-semibold text-gray-900">{categoria.categoria}</h4>
									<span class="text-lg">{getTendenciaIcon(categoria.tendencia)}</span>
								</div>
								<p class="text-sm text-gray-600">{categoria.aporte}</p>
							</div>
							<div class="text-right">
								<span class="text-xl font-bold text-purple-600">{categoria.cantidad}</span>
								<p class="text-xs text-gray-500">personas</p>
							</div>
						</div>
						
						<div class="mt-2">
							<div class="flex justify-between text-xs mb-1">
								<span>Engagement</span>
								<span>{categoria.porcentaje}%</span>
							</div>
							<div class="w-full bg-gray-200 rounded-full h-2">
								<div 
									class="bg-gradient-to-r from-purple-500 to-purple-400 rounded-full h-2 transition-all duration-1000" 
									style="width: {categoria.porcentaje}%"
								></div>
							</div>
						</div>
					</div>
				{/each}
			</div>
		</div>

		<!-- Métricas de Rendimiento -->
		<div 
			class="space-y-6"
			class:opacity-0={!animate}
			class:translate-y-4={!animate}
			style="transition-delay: 500ms"
		>
			<!-- Rendimiento General -->
			<div class="rounded-2xl border border-green-100 bg-green-50 p-6 shadow-lg">
				<h2 class="mb-4 text-lg font-bold text-green-900">📊 Rendimiento General</h2>
				<div class="space-y-3">
					<div class="flex justify-between">
						<span class="text-green-700">Promedio recaudación:</span>
						<span class="font-semibold text-green-900">${metricsRendimiento.promedioRecaudacion.toLocaleString()}</span>
					</div>
					<div class="flex justify-between">
						<span class="text-green-700">Tiempo promedio:</span>
						<span class="font-semibold text-green-900">{metricsRendimiento.tiempoPromedioCompletar}</span>
					</div>
					<div class="flex justify-between">
						<span class="text-green-700">Mejor mes:</span>
						<span class="font-semibold text-green-900">{metricsRendimiento.mejorMes}</span>
					</div>
				</div>
			</div>

			<!-- Alcance y Visibilidad -->
			<div class="rounded-2xl border border-blue-100 bg-blue-50 p-6 shadow-lg">
				<h2 class="mb-4 text-lg font-bold text-blue-900">👁️ Alcance y Visibilidad</h2>
				<div class="grid grid-cols-2 gap-4 text-center">
					<div>
						<p class="text-2xl font-bold text-blue-600">{estadisticasAlcance.totalVisualizaciones}</p>
						<p class="text-xs text-blue-700">Total vistas</p>
					</div>
					<div>
						<p class="text-2xl font-bold text-blue-600">{estadisticasAlcance.interaccionesUltimoMes}</p>
						<p class="text-xs text-blue-700">Interacciones</p>
					</div>
					<div>
						<p class="text-2xl font-bold text-blue-600">{estadisticasAlcance.compartidoEnRedes}</p>
						<p class="text-xs text-blue-700">Compartidos</p>
					</div>
					<div>
						<p class="text-2xl font-bold text-blue-600">{estadisticasAlcance.nuevosSeguidores}</p>
						<p class="text-xs text-blue-700">Nuevos seguidores</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Fila inferior: Próximas Acciones y Tendencias -->
	<div class="grid gap-6 lg:grid-cols-2">
		<!-- Próximas Acciones -->
		<div 
			class="rounded-2xl border border-orange-100 bg-orange-50 p-6 shadow-lg"
			class:opacity-0={!animate}
			class:translate-y-4={!animate}
			style="transition-delay: 600ms"
		>
			<h2 class="mb-6 text-lg font-bold text-orange-900">⚡ Próximas Acciones Requeridas</h2>
			
			<div class="space-y-3">
				{#each proximasAcciones as accion, i}
					<div 
						class="flex items-start gap-3 rounded-lg bg-white/60 p-3 transition-all duration-300 hover:bg-white/80"
						class:opacity-0={!animate}
						style="transition-delay: {700 + i * 100}ms"
					>
						<div class="text-2xl">
							{accion.tipo === 'deadline' ? '⏰' : accion.tipo === 'comunicacion' ? '📢' : '💰'}
						</div>
						<div class="flex-1">
							<p class="font-medium text-orange-900">{accion.descripcion}</p>
							<div class="flex items-center gap-2 mt-1">
								<span class="text-xs text-orange-700">{accion.fecha}</span>
								<span class="text-xs px-2 py-1 rounded-full {accion.urgencia === 'alta' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
									{accion.urgencia === 'alta' ? 'Urgente' : 'Normal'}
								</span>
							</div>
						</div>
					</div>
				{/each}
			</div>
		</div>

		<!-- Tendencias de Crecimiento -->
		<div 
			class="rounded-2xl border border-gray-200 bg-white p-6 shadow-lg"
			class:opacity-0={!animate}
			class:translate-y-4={!animate}
			style="transition-delay: 700ms"
		>
			<h2 class="mb-6 text-lg font-bold text-gray-900">📈 Tendencias de Crecimiento</h2>
			
			<div class="space-y-4">
				<div>
					<h4 class="text-sm font-medium text-gray-700 mb-2">Recaudación Mensual ($)</h4>
					<div class="flex items-end gap-1 h-20">
						{#each tendenciasMensuales as mes, i}
							<div class="flex flex-col items-center flex-1">
								<div 
									class="w-full bg-gradient-to-t from-purple-500 to-purple-400 rounded-t transition-all duration-1000"
									style="height: {(mes.recaudado / 35000) * 60}px; transition-delay: {800 + i * 100}ms"
								></div>
								<span class="mt-1 text-xs text-gray-600">{mes.mes}</span>
							</div>
						{/each}
					</div>
				</div>

				<div>
					<h4 class="text-sm font-medium text-gray-700 mb-2">Colaboradores Nuevos</h4>
					<div class="flex items-end gap-1 h-16">
						{#each tendenciasMensuales as mes, i}
							<div class="flex flex-col items-center flex-1">
								<div 
									class="w-full bg-gradient-to-t from-blue-500 to-blue-400 rounded-t transition-all duration-1000"
									style="height: {(mes.colaboradores / 50) * 40}px; transition-delay: {900 + i * 100}ms"
								></div>
								<span class="mt-1 text-xs text-gray-600">{mes.mes}</span>
							</div>
						{/each}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>