<!--
* Componente: GestionColaboraciones  
        -*- Descripci√≥n: Gesti√≥n completa de colaboraciones con selector de proyecto, estad√≠sticas y acciones
-->

<script lang="ts">
	import type { Proyecto } from '$lib/types/Proyecto';
	import type { Colaboracion } from '$lib/types/Colaboracion';
	import { formatearFecha } from '$lib/utils/validaciones';
	import { obtenerNombreColaborador } from '$lib/utils/util-colaboraciones';
	import { mockProyectos } from '$lib/mocks/mock-proyectos';
	import { mockColaboraciones } from '$lib/mocks/mock-colaboraciones';
	import Button from '$lib/components/ui/elementos/Button.svelte';

	// Filtro en_curso
	let proyectos: Proyecto[] = mockProyectos.filter(p => 
		p.estado === 'en_curso'
	);

	proyectos = proyectos.map(proyecto => ({
		...proyecto,
		colaboraciones: mockColaboraciones.filter(c => c.proyecto_id === proyecto.id_proyecto)
	}));

	let proyectoSeleccionado: Proyecto = proyectos[0] || mockProyectos[0];
	let proyectoSeleccionadoId: number = proyectoSeleccionado?.id_proyecto || 0;

	// Variables para el modal de rechazo
	let mostrarModalRechazo = false;
	let colaboracionARechazar: number | null = null;
	let justificacionRechazo = '';

	// cuando cambia el ID seleccionado, actualiza el proyecto
	$: if (proyectoSeleccionadoId) {
		const proyecto = proyectos.find((p) => p.id_proyecto === proyectoSeleccionadoId);
		if (proyecto) {
			proyectoSeleccionado = proyecto;
		}
	}

	function aceptarColaboracion(colaboracionId: number) {
		// Actualizar estado en el proyecto seleccionado
		if (proyectoSeleccionado.colaboraciones) {
			proyectoSeleccionado.colaboraciones = proyectoSeleccionado.colaboraciones.map(c => 
				c.id_colaboracion === colaboracionId 
					? { ...c, estado: 'aprobada' as const }
					: c
			);
		}

		console.log(`Colaboraci√≥n ${colaboracionId} aceptada`);
	}

	function mostrarModalParaRechazar(colaboracionId: number) {
		colaboracionARechazar = colaboracionId;
		justificacionRechazo = '';
		mostrarModalRechazo = true;
	}

	function cerrarModalRechazo() {
		mostrarModalRechazo = false;
		colaboracionARechazar = null;
		justificacionRechazo = '';
	}

	function confirmarRechazo() {
		if (colaboracionARechazar && proyectoSeleccionado.colaboraciones) {
			const justificacion = justificacionRechazo.trim() || 'Solicitud rechazada por la instituci√≥n';
			
			proyectoSeleccionado.colaboraciones = proyectoSeleccionado.colaboraciones.map(c => 
				c.id_colaboracion === colaboracionARechazar 
					? { ...c, estado: 'rechazada' as const, justificacion }
					: c
			);

			console.log(`Colaboraci√≥n ${colaboracionARechazar} rechazada con justificaci√≥n: ${justificacion}`);
		}
		
		cerrarModalRechazo();
	}

	function obtenerEmailColaborador(colaboracion: Colaboracion): string | undefined {
		const contactos = colaboracion.colaborador?.contactos;
		return contactos?.find(c => c.tipo_contacto === 'email')?.valor;
	}

	function obtenerTelefonoColaborador(colaboracion: Colaboracion): string | undefined {
		const contactos = colaboracion.colaborador?.contactos;
		return contactos?.find(c => c.tipo_contacto === 'telefono')?.valor;
	}

	function getTipoIcon(colaboracion: Colaboracion): string {
		// verificamos colaboradores (organizaciones o personas)
		if (colaboracion.colaborador && 'tipo_colaborador' in colaboracion.colaborador && colaboracion.colaborador.tipo_colaborador === 'organizacion') {
			return 'üè¢';
		}
		return 'üë§';
	}

	function getTipoLabel(colaboracion: Colaboracion): string {
		if (!colaboracion.colaborador) return 'Colaborador';
		// verificamos colaboradores (organizaciones o personas)
		if ('tipo_colaborador' in colaboracion.colaborador && colaboracion.colaborador.tipo_colaborador === 'organizacion') {
			return 'Organizaci√≥n';
		}
		
		// Si es unipersonal, mostrar "Persona"
		return 'Persona';
	}

	function getColaboracionesCount(proyecto: Proyecto): number {
		return proyecto.colaboraciones?.length || 0;
	}

	function getColaboracionesPendientes(proyecto: Proyecto): number {
		return proyecto.colaboraciones?.filter(c => c.estado === 'pendiente')?.length || 0;
	}

	function getColaboracionesAprobadas(proyecto: Proyecto): number {
		return proyecto.colaboraciones?.filter(c => c.estado === 'aprobada')?.length || 0;
	}

	function getColaboracionesRechazadas(proyecto: Proyecto): number {
		return proyecto.colaboraciones?.filter(c => c.estado === 'rechazada')?.length || 0;
	}

	function calcularDiasActivo(fecha: Date | undefined): number {
		if (!fecha) return 0;
		const fechaCreacion = new Date(fecha);
		const hoy = new Date();
		const diferencia = hoy.getTime() - fechaCreacion.getTime();
		return Math.floor(diferencia / (1000 * 3600 * 24));
	}

	// Estad√≠sticas del proyecto seleccionado
	$: colaboraciones = proyectoSeleccionado.colaboraciones || [];
	$: pendientes = colaboraciones.filter(c => c.estado === 'pendiente');
	$: aprobadas = colaboraciones.filter(c => c.estado === 'aprobada');
</script>

<svelte:head>
	<title>Solicitudes de colaboraci√≥n recibidas - Conectando Corazones</title>
	<meta name="description" content="Gestiona las solicitudes de colaboraci√≥n para tus proyectos" />
</svelte:head>

<main class="min-h-screen bg-gray-50">
	<div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
		<!-- Header -->
		<div class="mb-8">
			<h1 class="text-3xl font-bold text-[rgb(var(--base-color))]">Solicitudes de colaboraci√≥n recibidas</h1>
			<p class="mt-2 text-gray-600">Gestiona las solicitudes de colaboraci√≥n para tus proyectos</p>
		</div>

		<!-- Selector de proyecto -->
		{#if proyectos.length > 1}
			<div class="mb-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
				<div class="mb-4 flex items-center justify-between">
					<h2 class="text-lg font-semibold text-gray-900">Seleccionar proyecto</h2>
					<span class="text-sm text-gray-500">
						{proyectos.length} proyecto{proyectos.length !== 1 ? 's' : ''} total{proyectos.length !== 1 ? 'es' : ''}
					</span>
				</div>

				<div class="space-y-4">
					<!-- Selector dropdown -->
					<div>
						<label for="project-select" class="mb-2 block text-sm font-medium text-gray-700">
							Proyecto en curso:
						</label>
						<select
							id="project-select"
							bind:value={proyectoSeleccionadoId}
							class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm transition-colors focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-20"
						>
							{#each proyectos as proyecto}
								<option value={proyecto.id_proyecto}>
									{proyecto.titulo}
								</option>
							{/each}
						</select>
					</div>

					<!-- Informaci√≥n del proyecto seleccionado -->
					<div class="rounded-lg bg-gray-50 p-4">
						<div class="mb-3 flex items-start justify-between">
							<div class="flex-1">
								<h3 class="mb-1 font-medium text-gray-900">
									{proyectoSeleccionado.titulo}
								</h3>
								{#if proyectoSeleccionado.descripcion}
									<p class="line-clamp-2 text-sm text-gray-600">
										{proyectoSeleccionado.descripcion}
									</p>
								{/if}
							</div>
						</div>

						<!-- Estad√≠sticas r√°pidas -->
						<div class="grid grid-cols-4 gap-3">
							<div class="rounded-lg border border-gray-200 bg-white p-3">
								<div class="flex items-center">
									<div class="mr-2 text-orange-500">üì•</div>
									<div>
										<p class="text-xs text-gray-500">Pendientes</p>
										<p class="text-lg font-semibold text-gray-900">
											{getColaboracionesPendientes(proyectoSeleccionado)}
										</p>
									</div>
								</div>
							</div>

							<div class="rounded-lg border border-gray-200 bg-white p-3">
								<div class="flex items-center">
									<div class="mr-2 text-green-500">‚úÖ</div>
									<div>
										<p class="text-xs text-gray-500">Aprobadas</p>
										<p class="text-lg font-semibold text-gray-900">
											{getColaboracionesAprobadas(proyectoSeleccionado)}
										</p>
									</div>
								</div>
							</div>

							<div class="rounded-lg border border-gray-200 bg-white p-3">
								<div class="flex items-center">
									<div class="mr-2 text-red-500">‚ùå</div>
									<div>
										<p class="text-xs text-gray-500">Rechazadas</p>
										<p class="text-lg font-semibold text-gray-900">
											{getColaboracionesRechazadas(proyectoSeleccionado)}
										</p>
									</div>
								</div>
							</div>

							<div class="rounded-lg border border-gray-200 bg-white p-3">
								<div class="flex items-center">
									<div class="mr-2 text-blue-500">üìä</div>
									<div>
										<p class="text-xs text-gray-500">Total</p>
										<p class="text-lg font-semibold text-gray-900">
											{getColaboracionesCount(proyectoSeleccionado)}
										</p>
									</div>
								</div>
							</div>
						</div>

						<!-- Informaci√≥n adicional -->
						<div class="mt-4 space-y-2">
							{#if proyectoSeleccionado.fecha_fin_tentativa}
								<p class="text-xs text-gray-500">
									<span class="font-medium">Finalizaci√≥n tentativa:</span>
									{formatearFecha(proyectoSeleccionado.fecha_fin_tentativa)}
								</p>
							{/if}

							{#if proyectoSeleccionado.created_at}
								<p class="text-xs text-gray-500">
									<span class="font-medium">Creado el:</span>
									{formatearFecha(proyectoSeleccionado.created_at)}
								</p>
							{/if}
						</div>
					</div>
				</div>
			</div>
		{/if}
		<!-- Dos columnas: Solicitudes + Colaboradores activos -->
		<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
			<!-- Solicitudes de colaboraci√≥n (pendientes) -->
			<div class="rounded-lg border border-gray-200 bg-white shadow-sm">
				<div class="border-b border-gray-200 px-6 py-4">
					<div class="flex items-center justify-between">
						<h2 class="text-lg font-semibold text-gray-900">Solicitudes de colaboraci√≥n</h2>
						<span class="inline-flex items-center rounded-full bg-orange-100 px-2.5 py-0.5 text-xs font-medium text-orange-800">
							{pendientes.length} pendiente{pendientes.length !== 1 ? 's' : ''}
						</span>
					</div>
				</div>

				<div class="divide-y divide-gray-200">
					{#if pendientes.length === 0}
						<div class="px-6 py-12 text-center">
							<div class="mb-4 text-4xl">üì•</div>
							<h3 class="mb-2 text-lg font-medium text-gray-900">No hay solicitudes pendientes</h3>
							<p class="text-gray-500">
								Cuando recibas solicitudes de colaboraci√≥n aparecer√°n aqu√≠ para que puedas gestionarlas.
							</p>
						</div>
					{:else}
						{#each pendientes as colaboracion (colaboracion.id_colaboracion)}
							<div class="px-6 py-4 transition-colors hover:bg-gray-50">
								<div class="flex items-start justify-between">
									<div class="flex-1">
										<div class="mb-2 flex items-center gap-3">
											<span class="text-2xl">{getTipoIcon(colaboracion)}</span>
											<div>
												<h3 class="text-base font-medium text-gray-900">
													{obtenerNombreColaborador(colaboracion.colaborador)}
												</h3>
												<p class="text-sm text-gray-500">
													{getTipoLabel(colaboracion)} ‚Ä¢ Postulado el {formatearFecha(colaboracion.created_at)}
												</p>
											</div>
										</div>

										{#if obtenerEmailColaborador(colaboracion)}
											<p class="mb-1 text-sm text-gray-600">
												<span class="font-medium">Email:</span>
												{obtenerEmailColaborador(colaboracion)}
											</p>
										{/if}

										{#if obtenerTelefonoColaborador(colaboracion)}
											<p class="mb-1 text-sm text-gray-600">
												<span class="font-medium">Tel√©fono:</span>
												{obtenerTelefonoColaborador(colaboracion)}
											</p>
										{/if}

										{#if colaboracion.mensaje}
											<div class="mt-3 rounded-lg bg-gray-50 p-3">
												<p class="text-sm text-gray-700">
													<span class="font-medium">Mensaje:</span>
												</p>
												<p class="mt-1 text-sm text-gray-600">
													{colaboracion.mensaje}
												</p>
											</div>
										{/if}

										{#if colaboracion.estado === 'rechazada' && colaboracion.justificacion}
											<div class="mt-3 rounded-lg bg-red-50 p-3">
												<p class="text-sm text-red-700">
													<span class="font-medium">Motivo del rechazo:</span>
												</p>
												<p class="mt-1 text-sm text-red-600">
													{colaboracion.justificacion}
												</p>
											</div>
										{/if}
									</div>

									<div class="ml-6 flex flex-col gap-2">
										<Button
											label="‚úì Aceptar"
											variant="primary"
											size="sm"
											type="button"
											on:click={() => aceptarColaboracion(colaboracion.id_colaboracion || 0)}
											customClass="!bg-green-600 hover:!bg-green-700 !min-w-[90px]"
										/>
										<Button
											label="‚úï Rechazar"
											variant="secondary"
											size="sm"
											type="button"
											on:click={() => mostrarModalParaRechazar(colaboracion.id_colaboracion || 0)}
											customClass="!bg-red-600 hover:!bg-red-700 !text-white !min-w-[90px]"
										/>
									</div>
								</div>
							</div>
						{/each}
					{/if}
				</div>
			</div>

			<!-- Colaboradores activos (aprobadas) -->
			<div class="rounded-lg border border-gray-200 bg-white shadow-sm">
				<div class="border-b border-gray-200 px-6 py-4">
					<div class="flex items-center justify-between">
						<h2 class="text-lg font-semibold text-gray-900">Colaboradores activos</h2>
						<span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
							{aprobadas.length} activo{aprobadas.length !== 1 ? 's' : ''}
						</span>
					</div>
				</div>

				<div class="divide-y divide-gray-200">
					{#if aprobadas.length === 0}
						<div class="px-6 py-12 text-center">
							<div class="mb-4 text-4xl">ü§ù</div>
							<h3 class="mb-2 text-lg font-medium text-gray-900">A√∫n no tienes colaboradores</h3>
							<p class="text-gray-500">
								Los colaboradores aceptados aparecer√°n aqu√≠. Revisa las solicitudes pendientes para encontrar personas dispuestas a ayudar.
							</p>
						</div>
					{:else}
						{#each aprobadas as colaboracion (colaboracion.id_colaboracion)}
							<div class="px-6 py-4">
								<div class="flex items-start justify-between">
									<div class="flex items-center gap-3">
										<span class="text-2xl">{getTipoIcon(colaboracion)}</span>
										<div>
											<h3 class="text-base font-medium text-gray-900">
												{obtenerNombreColaborador(colaboracion.colaborador)}
											</h3>
											<p class="text-sm text-gray-500">
												{getTipoLabel(colaboracion)}
											</p>
											{#if colaboracion.created_at}
												<p class="mt-1 text-xs text-gray-400">
													Colaborando desde el {formatearFecha(colaboracion.created_at)}
													({calcularDiasActivo(colaboracion.created_at)} d√≠as)
												</p>
											{/if}
										</div>
									</div>

									<div class="flex items-center gap-2">
										<span class="inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-700">
											‚úì Activo
										</span>
									</div>
								</div>

								{#if obtenerEmailColaborador(colaboracion)}
									<div class="mt-3 pl-11">
										<p class="text-sm text-gray-600">
											<span class="font-medium">Email:</span>
											<a
												href="mailto:{obtenerEmailColaborador(colaboracion)}"
												class="text-blue-600 transition-colors hover:text-blue-800"
											>
												{obtenerEmailColaborador(colaboracion)}
											</a>
										</p>
									</div>
								{/if}

								{#if obtenerTelefonoColaborador(colaboracion)}
									<div class="mt-1 pl-11">
										<p class="text-sm text-gray-600">
											<span class="font-medium">Tel√©fono:</span>
											<a
												href="tel:{obtenerTelefonoColaborador(colaboracion)}"
												class="text-blue-600 transition-colors hover:text-blue-800"
											>
												{obtenerTelefonoColaborador(colaboracion)}
											</a>
										</p>
									</div>
								{/if}
							</div>
						{/each}
					{/if}
				</div>
			</div>
		</div>
	</div>
</main>

<!-- Modal de rechazo Marca error de accesibilidad, pero funciona bien con esos comentarios, pss no borrarlos -->
{#if mostrarModalRechazo}
	<!-- svelte-ignore a11y-click-events-have-key-events -->
	<!-- svelte-ignore a11y-no-static-element-interactions -->
	<div class="fixed inset-0 z-50 flex items-center justify-center" on:click={cerrarModalRechazo}>
	<!-- svelte-ignore a11y-click-events-have-key-events -->
	<!-- svelte-ignore a11y-no-static-element-interactions -->
		<div class="bg-white rounded-lg shadow-2xl border border-gray-200 max-w-md w-full mx-4 p-6" on:click|stopPropagation>
			<div class="mb-4">
				<h3 class="text-lg font-semibold text-gray-900">Rechazar solicitud de colaboraci√≥n</h3>
				<p class="mt-2 text-sm text-gray-600">
					Coloque una justificaci√≥n del por qu√© rechaza la solicitud de colaboraci√≥n (opcional)
				</p>
			</div>

			<div class="mb-6">
				<label for="justificacion-rechazo" class="block text-sm font-medium text-gray-700 mb-2">
					Justificaci√≥n del rechazo:
				</label>
				<textarea
					id="justificacion-rechazo"
					bind:value={justificacionRechazo}
					rows="4"
					class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
					placeholder="Ejemplo: No cumple con los requisitos espec√≠ficos del proyecto..."
				></textarea>
			</div>

			<div class="flex justify-end space-x-3">
				<Button
					label="Cancelar"
					variant="secondary"
					size="sm"
					type="button"
					on:click={cerrarModalRechazo}
					customClass="!bg-gray-100 !text-gray-700 hover:!bg-gray-200"
				/>
				<Button
					label="Confirmar rechazo"
					variant="secondary"
					size="sm"
					type="button"
					on:click={confirmarRechazo}
					customClass="!bg-red-600 hover:!bg-red-700 !text-white"
				/>
			</div>
		</div>
	</div>
{/if}
